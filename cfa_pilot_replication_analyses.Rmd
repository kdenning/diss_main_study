---
title: "Pilot Replication Analyses"
output: 
    html_document:
      code_download: TRUE
      toc: TRUE
      toc_float:
        collapsed: FALSE
      toc_depth: 1
      code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r data prep, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
# Loading packages
library(psych)
library(effects)
library(magrittr) # part of the tidyverse but must be read in on its own
library(parameters)
library(dplyr)
library(tidyr)
library(rio)
library(ggplot2)
library(emmeans)
library(lavaan)
library(corrplot)

# Functions to clean document, get data from wide to long format
source("functions/Cleaning.R")

# Setting global chunk options
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

options(scipen = 999)

# Importing data
wide_data <- import("data/diss_main_combined_data_basic_clean.csv")

# Cleaning data using functions
long_data <- get_wrangled(wide_data)

clean_data <- remove_participants(long_data)
```

# Confirming Target Threat Factor {.tabset .tabset-fade .tabset-pills}

## Correlation matrix

```{r}
cfa_vars <- clean_data %>% 
  select(sub_id, distance_coffee, distance_town, realistic_q, 
         symbolic_q, explicit_targ, explicit_group) %>% 
  unique() %>% 
  na.omit() %>% 
  select(distance_coffee, distance_town, realistic_q, 
         symbolic_q, explicit_targ, explicit_group)

cor_matrix_cfa <- cor(cfa_vars)
cor_matrix_cfa

cor_plot_cfa <- corrplot(cor_matrix_cfa, method = "number")

colnames(cor_plot_cfa) = rep(c('Distance: Coffee', 
                                       'Distance: Town',
                                       'Realistic',
                                       'Symbolic',
                                       'Explicit: Target',
                                       'Explicit: Group'))

rownames(cor_plot_cfa) = rep(c('Distance: Coffee', 
                                       'Distance: Town',
                                       'Realistic',
                                       'Symbolic',
                                       'Explicit: Target',
                                       'Explicit: Group'))
corrplot(cor_plot_cfa, 
         is.corr = TRUE, 
         #method = "number", 
         method = 'color',
         col.lim = c(0, 1),
         tl.cex = .85,
         tl.col = 'black',
         addgrid.col = 'white',
         addCoef.col = 'grey50')

```

*This corresponds to factorability, an assumption of Factor Analysis*

The results are consistent with the Pilot Analysis - symbolic and realistic are highly correlated to one another and highly correlated with target-level explicit threat, but not group-level explicit threat. Validates that symbolic and realistic threat are measuring target-level threat, and that these measures differ from implicit measures of physical distancing.

## nfactors

```{r}
par(mar=c(1,1,1,1))
nfactors(cfa_vars)
```

## CFA Model

```{r}

cfa_vars_3 <- cfa_vars %>% 
  select(symbolic_q, realistic_q, explicit_targ)

cfa_mod  <- 'target_threat  =~ symbolic_q + realistic_q + explicit_targ'

onefac_cfa <- cfa(cfa_mod, data = cfa_vars_2) 
summary(onefac_cfa) 
```

Might not be the correct analysis due to small number of indicators

## Alpha

```{r}
cfa_vars_2 <- cfa_vars %>% 
  select(symbolic_q, realistic_q)

psych::alpha(cfa_vars_2)
```

## Composite target threat measure

```{r}
clean_data %<>%   
  mutate(itt_comp = rowMeans(select(., c("realistic_q", "symbolic_q"))))

```

### Mean

```{r}
mean(clean_data$itt_comp)
```

### SD

```{r}
sd(clean_data$itt_comp)
```

### Range

```{r}
range(clean_data$itt_comp)
```

# ANOVA {.tabset .tabset-fade .tabset-pills}

## Summary results

```{r}
contrasts(clean_data$target_condition)
results <- aov(itt_comp ~ target_condition, data = clean_data)
summary(results)
```

#### Residuals & Heteroscedastisticity

```{r}
plot(results)
```

A little weird, but working with categorical variables. The QQ especially suggests some non-normality of residuals, but regression models are robust to violations of normality and heteroscedastisticity.

#### Post-hoc test

```{r}
emmeans(results, pairwise ~ target_condition)
```

The loss target results in the the most threat, which is significantly higher than both the warm and control conditions. The control condition results in the least threat, which is significantly lower than the warm condition. This replicates the pilot study.

