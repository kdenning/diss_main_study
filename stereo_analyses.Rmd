---
title: "Residual Counter-Projection"
output: 
    html_document:
      code_download: TRUE
      toc: TRUE
      toc_float:
        collapsed: FALSE
      toc_depth: 1
      code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r data prep, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
# Loading packages
library(psych)
library(lme4)
library(nlme)
library(sjPlot)
library(effects)
library(magrittr) # part of the tidyverse but must be read in on its own
library(parameters)
library(dplyr)
library(tidyr)
library(rio)
library(ggplot2)
library(emmeans)
library(corrplot)

# Functions to clean document, get data from wide to long format
source("functions/Cleaning.R")

# Setting global chunk options
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

options(scipen = 999)

# Importing data
wide_data <- import("data/diss_main_combined_data_basic_clean.csv")

# Cleaning data using functions
long_data_bfi <- get_wrangled_bfi(wide_data)
long_data_eli <- get_wrangled_eli(wide_data)

clean_vars_bfi <- get_vars_cleaned(long_data_bfi)
clean_vars_eli <- get_vars_cleaned(long_data_eli)

clean_data_bfi <- remove_participants(clean_vars_bfi)
clean_data_eli <- remove_participants(clean_vars_eli)

clean_data_bfi %<>%    
  mutate(itt_comp = rowMeans(select(., c("realistic_q", "symbolic_q"))),
         itt_comp_gmc = scale(itt_comp, center = T, scale = F))

clean_data_eli %<>%    
  mutate(itt_comp = rowMeans(select(., c("realistic_q", "symbolic_q"))),
         itt_comp_gmc = scale(itt_comp, center = T, scale = F))
```

# Projection for comparison (no stereotyping) {.tabset .tabset-fade .tabset-pills}

## Only composite

```{r}
data_bfi <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, itt_comp_gmc,
         target_condition, bfi_targ, bfi_self, bfi_stereo, bfi_stereo_pmc) %>% 
  unique() %>% 
  na.omit() 

bfi_nostereo_comp <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc +
                     (bfi_self_pmc | sub_id), data = data_bfi)
summary(bfi_nostereo_comp)
tab_model(bfi_nostereo_comp)
```


### Simple Slopes

```{r}
threat_levels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07))
simpslopes_bfi_nostereo2 <- emtrends(bfi_nostereo_comp, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = c(threat_levels))


simpslopes_bfi_nostereo2
pairs(simpslopes_bfi_nostereo2)
```

### Visualization

```{r}
bfi_nostereo_comp_df <- effect("bfi_self_pmc:itt_comp_gmc",
                         xlevels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07)),
                         mod = bfi_nostereo_comp)

bfi_nostereo_comp_df <- as.data.frame(bfi_nostereo_comp_df)
bfi_nostereo_comp_df$itt_comp_gmc <- as.factor(bfi_nostereo_comp_df$itt_comp_gmc)

ggplot(bfi_nostereo_comp_df, aes(bfi_self_pmc, fit, group = itt_comp_gmc)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = itt_comp_gmc)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  scale_linetype_manual("Threat composite",
                        breaks = c("-1.07", "0", "1.07"), 
                       labels = c("Low",
                                  "Average",
                                  "High"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(title = "Projection by target-level threat",
         subtitle = "Using the BFI",
       x = "BFI responses for self",
       y = "BFI responses for target")
```

### Residuals

```{r}
# checking normality of conditional residuals
qqnorm(residuals(bfi_nostereo_comp), main="Q-Q plot for conditional residuals")

# checking the normality of the random effects (here random intercept):
qqnorm(ranef(bfi_nostereo_comp)$sub_id$bfi_self_pmc,
       main="Q-Q plot for the self random effect")

# Checking residuals for intercept
qqnorm(ranef(bfi_nostereo_comp)$sub_id$`(Intercept)`,
       main="Q-Q plot for the random intercept")
```

## Target condition  x composite

```{r}
bfi_nostereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*target_condition +
                     (bfi_self_pmc | sub_id), data = data_bfi)
summary(bfi_nostereo)
tab_model(bfi_nostereo)
```

### Simple Slopes

```{r}
targ_levels <-list(target_condition = c("CONTROL", "LOSS", "WARM"))
simpslopes_bfi_nostereo1 <- emtrends(bfi_nostereo, ~ itt_comp_gmc*target_condition,
                              var ="bfi_self_pmc",
                              at = c(targ_levels, threat_levels))


simpslopes_bfi_nostereo1
pairs(simpslopes_bfi_nostereo1)
```

### Visualization

```{r}
bfi_no_stereo_df <- effect("bfi_self_pmc:itt_comp_gmc:target_condition",
                         xlevels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07),
                                        target_condition = c("CONTROL",
                                                             "WARM",
                                                             "LOSS")),
                         mod = bfi_nostereo)

bfi_no_stereo_df <- as.data.frame(bfi_no_stereo_df)
bfi_no_stereo_df$itt_comp_gmc <- as.factor(bfi_no_stereo_df$itt_comp_gmc)
bfi_no_stereo_df$target_condition <- as.factor(bfi_no_stereo_df$target_condition)

bfi_no_stereo_df %<>% 
  mutate(target_condition = forcats::fct_relevel(target_condition, c("CONTROL", "WARM", "LOSS")))

target_labels <- c("CONTROL" = "Control",
                   "WARM" = "Warm",
                   "LOSS" = "Loss")

ggplot(bfi_no_stereo_df, aes(bfi_self_pmc, fit, group = itt_comp_gmc)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = itt_comp_gmc)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  facet_wrap(~target_condition,
             labeller = labeller(target_condition = target_labels)) +
  scale_linetype_manual("Threat composite",
                        breaks = c("-1.07", "0", "1.07"), 
                       labels = c("Low",
                                  "Average",
                                  "High"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(title = "Projection by target-level threat and target condition",
         subtitle = "Using the BFI",
       x = "BFI responses for self",
       y = "BFI responses for target")
```

### Residuals

```{r}
# checking normality of conditional residuals
qqnorm(residuals(bfi_nostereo), main="Q-Q plot for conditional residuals")

# checking the normality of the random effects (here random intercept):
qqnorm(ranef(bfi_nostereo)$sub_id$bfi_self_pmc,
       main="Q-Q plot for the self random effect")

# Checking residuals for intercept
qqnorm(ranef(bfi_nostereo)$sub_id$`(Intercept)`,
       main="Q-Q plot for the random intercept")
```

More normal, but a little tail

# Residual Counter-projection (with steroetyping) {.tabset .tabset-fade .tabset-pills}

## Only composite

### Results

```{r}
bfi_stereo_comp <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*bfi_stereo_pmc +
                     (bfi_self_pmc + bfi_stereo_pmc | sub_id), data = data_bfi)
summary(bfi_stereo_comp)
tab_model(bfi_stereo_comp)
```


### Simple Slopes

```{r}
simpslopes_bfi_stereo2 <- emtrends(bfi_stereo_comp, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = c(threat_levels))


simpslopes_bfi_stereo2
pairs(simpslopes_bfi_stereo2)
```

### Visualization

```{r}
bfi_stereo_comp_df <- effect("bfi_self_pmc:itt_comp_gmc",
                         xlevels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07)),
                         mod = bfi_stereo_comp)

bfi_stereo_comp_df <- as.data.frame(bfi_stereo_comp_df)
bfi_stereo_comp_df$itt_comp_gmc <- as.factor(bfi_stereo_comp_df$itt_comp_gmc)

ggplot(bfi_stereo_comp_df, aes(bfi_self_pmc, fit, group = itt_comp_gmc)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = itt_comp_gmc)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  scale_linetype_manual("Threat composite",
                        breaks = c("-1.07", "0", "1.07"), 
                       labels = c("Low",
                                  "Average",
                                  "High"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(title = "Residual projection by target-level threat",
         subtitle = "Using the BFI; After accounting for stereotyping",
       x = "BFI responses for self",
       y = "BFI responses for target")
```

### Residuals

```{r}
# checking normality of conditional residuals
qqnorm(residuals(bfi_stereo_comp), main="Q-Q plot for conditional residuals")

# checking the normality of the random effects (here random intercept):
qqnorm(ranef(bfi_stereo_comp)$sub_id$bfi_self_pmc,
       main="Q-Q plot for the self random effect")

qqnorm(ranef(bfi_stereo_comp)$sub_id$bfi_stereo_pmc,
       main="Q-Q plot for the stereotyping random effect")

# Checking residuals for intercept
qqnorm(ranef(bfi_stereo_comp)$sub_id$`(Intercept)`,
       main="Q-Q plot for the random intercept")
```

Also seems to have slight tails, basically when stereotyping is added to the model

## Composite x Target Condition

### Results

```{r}
bfi_stereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*target_condition*bfi_stereo_pmc +
                     (bfi_self_pmc + bfi_stereo_pmc | sub_id), data = data_bfi)
summary(bfi_stereo)
tab_model(bfi_stereo)
```


### Simple Slopes

```{r}
simpslopes_bfi_stereo1 <- emtrends(bfi_stereo, ~ itt_comp_gmc*target_condition,
                              var ="bfi_self_pmc",
                              at = c(targ_levels, threat_levels))


simpslopes_bfi_stereo1
pairs(simpslopes_bfi_stereo1)
```

With residual counter-projection, people do not project nor counter-project when they report higher than average threat. Otherwise, people project normally. Though slightly different from predicted, this demonstrates that threat does reduce projection after accounting for stereotyping with those who perceive high threat, but not others. However, there is not a residual effect of counter-projection with the BFI - which I believe is consistent with PSPB.

Is this consistent with PSPB?

### Visualization

```{r}
bfi_stereo_df <- effect("bfi_self_pmc:itt_comp_gmc:target_condition",
                         xlevels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07),
                                        target_condition = c("CONTROL",
                                                             "WARM",
                                                             "LOSS")),
                         mod = bfi_stereo)

bfi_stereo_df <- as.data.frame(bfi_stereo_df)
bfi_stereo_df$itt_comp_gmc <- as.factor(bfi_stereo_df$itt_comp_gmc)
bfi_stereo_df$target_condition <- as.factor(bfi_stereo_df$target_condition)

bfi_stereo_df %<>% 
  mutate(target_condition = forcats::fct_relevel(target_condition, c("CONTROL", "WARM", "LOSS")))

ggplot(bfi_stereo_df, aes(bfi_self_pmc, fit, group = itt_comp_gmc)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = itt_comp_gmc)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  facet_wrap(~target_condition,
             labeller = labeller(target_condition = target_labels)) +
  scale_linetype_manual("Threat composite",
                        breaks = c("-1.07", "0", "1.07"), 
                       labels = c("Low",
                                  "Average",
                                  "High"),
                       values = c("solid",
                                  "dashed",
                                  "dotted"))+
    labs(title = "Residual projection by target-level threat and target condition",
         subtitle = "Using the BFI; After accounting for stereotyping",
       x = "BFI responses for self",
       y = "BFI responses for target")
```

### Residuals

```{r}
# checking normality of conditional residuals
qqnorm(residuals(bfi_stereo), main="Q-Q plot for conditional residuals")

# checking the normality of the random effects 
qqnorm(ranef(bfi_stereo)$sub_id$bfi_self_pmc,
       main="Q-Q plot for the self random effect")

qqnorm(ranef(bfi_stereo)$sub_id$bfi_stereo_pmc,
       main="Q-Q plot for the stereotyping random effect")

# Checking residuals for intercept
qqnorm(ranef(bfi_stereo)$sub_id$`(Intercept)`,
       main="Q-Q plot for the random intercept")
```

Definitely a tail, but only a few points, so most likely robust; stereo is the worst, may need to transform it

# Multicolinearity of predictors

```{r}
cor_bfi <- data_bfi %>% 
  select(bfi_self_pmc, bfi_stereo_pmc, itt_comp_gmc) %>% 
  unique()

correlations_preds <- cor(cor_bfi)

corrplot(correlations_preds, 
         is.corr = TRUE, 
         #method = "number", 
         method = 'color',
         tl.cex = .85,
         tl.col = 'black',
         addgrid.col = 'white',
         addCoef.col = 'grey50')

```