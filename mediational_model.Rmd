---
title: "Mediational Model"
output: 
    html_document:
      code_download: TRUE
      toc: TRUE
      toc_float:
        collapsed: FALSE
      toc_depth: 1
      code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r data prep, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
# Loading packages
library(psych)
library(lme4)
library(nlme)
library(sjPlot)
library(effects)
library(magrittr) # part of the tidyverse but must be read in on its own
library(parameters)
library(dplyr)
library(tidyr)
library(rio)
library(ggplot2)
library(emmeans)
library(corrplot)

# Functions to clean document, get data from wide to long format
source("functions/Cleaning.R")

# Setting global chunk options
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

options(scipen = 999)

# Importing data
wide_data <- import("data/diss_main_combined_data_basic_clean.csv")

# Cleaning data using functions
long_data <- get_wrangled(wide_data)

clean_data <- remove_participants(long_data)

clean_data %<>%    
  mutate(itt_comp = rowMeans(select(., c("realistic_q", "symbolic_q"))),
         itt_comp_gmc = scale(itt_comp, center = T, scale = F))
```

https://cran.r-project.org/web/packages/mlma/vignettes/MLMAvignette.html

https://journals.plos.org/plosone/article/file?type=printable&id=10.1371/journal.pone.0241072

I keep seeing the Bauer approach but it doesn't appear to use bootstrapping and I don't entirely understand it... Option 3 here makes sense to me, but would I do multiple models first and then this at the end?:
https://quantdev.ssri.psu.edu/sites/qdev/files/ILD_Ch07_2017_Within-PersonMedationWithMLM.html

Multicolinearity across levels?

# Model 1: Threat on Counter-projection

## BFI

### Correlation matrix (multicolinearity)

```{r}
cor_predictors1 <- clean_data %>% 
  select(sub_id, bfi_number, bfi_self, bfi_targ, itt_comp) %>% 
  unique() %>% 
  na.omit() %>% 
  select(bfi_self, bfi_targ, itt_comp)

cor_matrix_predictors1 <- cor(cor_predictors1)
cor_matrix_predictors1

cor_plot_predictors1 <- corrplot(cor_matrix_predictors1, method = "number")

colnames(cor_plot_predictors1) = rep(c('BFI: Self',
                                       'BFI: Target',
                                       'Threat Composite'))

rownames(cor_plot_predictors1) = rep(c('BFI: Self',
                                       'BFI: Target',
                                       'Threat Composite'))
corrplot(cor_plot_predictors1, 
         is.corr = TRUE, 
         #method = "number", 
         method = 'color',
         col.lim = c(0, 1),
         tl.cex = .85,
         tl.col = 'black',
         addgrid.col = 'white',
         addCoef.col = 'grey50')
```

### MLM Results

#### With random intercept

*Tested basic model without threat because singularities kept occurring.*

```{r}
mod_1_data_bfi <- clean_data %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, itt_comp_gmc, 
         target_condition) %>% 
  unique() %>% 
  na.omit() 

model1_bfi_randint <- lmer(bfi_targ_pmc ~ bfi_self_pmc + 
                     (1 | sub_id), 
                   data = mod_1_data_bfi) # Model only works with the whole data-set (clean_data), not when filtered down to only include observations (thus none repeated) for this analysis with mod_1_data_bfi

tab_model(model1_bfi_randint,
          digits = 3)
```

##### Exploring ICC

```{r}
#simple linear model to see if school association leads to too high of an ICC
icc_mod_bfi <- lm(bfi_targ_pmc ~ bfi_self_pmc, data = mod_1_data_bfi)

#getting anova results of simple linear model from earlier
icc_mod_res_bfi = anova(icc_mod_bfi)

ICC_bfi = icc_mod_res_bfi$`Sum Sq`[1] / sum(icc_mod_res_bfi$`Sum Sq`)
ICC_bfi #The ICC is tiny - is this why I am getting a singular analysis?
```

Low ICC could be to blame.

##### More descriptives

```{r}
psych::describe(mod_1_data_bfi)
```

Re-checking the descriptives of these particular variables and they look normal.

### Random Slopes/No random Intercept

I think the singularities had to do with zero variance of the random intercept.

```{r}
model1_bfi_randslopes <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc + 
                     (0 + bfi_self_pmc | sub_id), 
                   data = mod_1_data_bfi) # Model only works with the whole data-set (clean_data), not when filtered down to only include observations (thus none repeated) for this analysis with mod_1_data_bfi

tab_model(model1_bfi_randslopes,
          digits = 3)
```

After removing the zero intercept and only allowing random slopes for responses for the self, the model ran without issues. Results indicate there is a main effect of threat on projection, where projection decreases as threat increases.

#### Simple Slopes

```{r}
threat_levels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07))
mod1_simpslopes_bfi <- emtrends(model1_bfi_randslopes, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

mod1_simpslopes_bfi
```

#### Visualization

```{r}
mod1_bfi_maineffect <- effect("bfi_self_pmc:itt_comp_gmc",
                         xlevels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07)),
                         mod = model1_bfi_randslopes)

mod1_bfi_maineffect <- as.data.frame(mod1_bfi_maineffect)
mod1_bfi_maineffect$itt_comp_gmc <- as.factor(mod1_bfi_maineffect$itt_comp_gmc)

ggplot(mod1_bfi_maineffect, aes(bfi_self_pmc, fit, group = itt_comp_gmc)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = itt_comp_gmc)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  scale_linetype_manual("Target-level \nthreat",
                        breaks = c(-1.07, 0, 1.07), 
                       labels = c("Low",
                                  "Average",
                                  "High"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(title = "Projection by target-level threat",
         subtitle = "Using the BFI",
       x = "BFI responses for self",
       y = "BFI responses for target")
```

## ELI

### Correlation matrix (multicolinearity)

```{r}
cor_predictors_eli <- clean_data %>% 
  select(sub_id, eli_number, eli_self, eli_targ, itt_comp) %>% 
  unique() %>% 
  na.omit() %>% 
  select(eli_self, eli_targ, itt_comp)

cor_matrix_predictors_eli <- cor(cor_predictors_eli)
cor_matrix_predictors_eli

cor_plot_predictors_eli <- corrplot(cor_matrix_predictors_eli, method = "number")

colnames(cor_plot_predictors_eli) = rep(c('ELI: Self',
                                      'ELI: Target',
                                      'Threat Composite'))

rownames(cor_plot_predictors_eli) = rep(c('ELI: Self',
                                      'ELI: Target',
                                      'Threat Composite'))
corrplot(cor_plot_predictors_eli, 
         is.corr = TRUE, 
         #method = "number", 
         method = 'color',
         col.lim = c(0, 1),
         tl.cex = .85,
         tl.col = 'black',
         addgrid.col = 'white',
         addCoef.col = 'grey50')
```

### MLM

#### Random intercept

```{r}
mod_1_data_eli <- clean_data %>% 
  select(sub_id, eli_number, eli_targ_pmc, eli_self_pmc, itt_comp_gmc,
         target_condition) %>% 
  unique() %>% 
  na.omit() 

model1_eli_randint <- lmer(eli_targ_pmc ~ eli_self_pmc + # itt does not work as a RE; model does not converge
                     (1 | sub_id), 
                   data = mod_1_data_eli) # Same as above, works with clean_data but not the smaller df specific to this analysis

tab_model(model1_eli_randint,
          digits = 3)
```

#### Exploring ICC

```{r}
#simple linear model to see if school association leads to too high of an ICC
icc_mod_eli <- lm(eli_targ_pmc ~ eli_self_pmc, data = mod_1_data_eli)

#getting anova results of simple linear model from earlier
icc_mod_res_eli = anova(icc_mod_eli)

ICC_eli = icc_mod_res_eli$`Sum Sq`[1] / sum(icc_mod_res_eli$`Sum Sq`)
ICC_eli #The ICC is tiny - is this why I am getting a singular analysis?
```

### Random Slopes/No random intercept

```{r}
model1_eli_randslopes <- lmer(eli_targ_pmc ~ eli_self_pmc*itt_comp_gmc + # itt does not work as a RE; model does not converge
                     (0 + eli_self_pmc | sub_id), 
                   data = mod_1_data_eli) # Same as above, works with clean_data but not the smaller df specific to this analysis

tab_model(model1_eli_randslopes,
          digits = 3)
```

#### Simple Slopes

```{r}
mod1_simpslopes_eli <- emtrends(model1_eli_randslopes, ~ itt_comp_gmc,
                              var ="eli_self_pmc",
                              at = threat_levels)

mod1_simpslopes_eli
```

#### Visualization

```{r}
mod1_eli_maineffect <- effect("eli_self_pmc:itt_comp_gmc",
                         xlevels = list(itt_comp_gmc = c(-1.07, 0, 1.07)),
                         mod = model1_eli_randslopes)

mod1_eli_maineffect <- as.data.frame(mod1_eli_maineffect)
mod1_eli_maineffect$itt_comp_gmc <- as.factor(mod1_eli_maineffect$itt_comp_gmc)

ggplot(mod1_eli_maineffect, aes(eli_self_pmc, fit, group = itt_comp_gmc)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = itt_comp_gmc)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  scale_linetype_manual("Target-level \nthreat",
                        breaks = c(-1.07, 0, 1.07), 
                       labels = c("Low",
                                  "Average",
                                  "High"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(title = "Projection by target-level threat",
         subtitle = "Using the ELI",
       x = "ELI responses for self",
       y = "ELI responses for target")
```

# Model 1b: Added threat condition

*Technically not pre-registered or predicted, but consistent with other predictions about threat*

## BFI

### MLM Results

### Random Slopes/No random Intercept

```{r}
model1b_bfi_randslopes <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc
                               *target_condition + 
                     (0 + bfi_self_pmc | sub_id), 
                   data = mod_1_data_bfi) # Model only works with the whole data-set (clean_data), not when filtered down to only include observations (thus none repeated) for this analysis with mod_1_data_bfi

tab_model(model1b_bfi_randslopes,
          digits = 3)
```

Results indicate that the main effect of the target-level threat composite goes away when we include threat condition. There is a main effect of condition on projection for both contrasts. There is also an interaction of target condition and the the threat composite for the contrast comparing the warm target to the control.

#### Simple Slopes

##### Target condition main effect

```{r}
mod1b_simpslopes_bfi_me <- emtrends(model1b_bfi_randslopes, ~ target_condition,
                              var ="bfi_self_pmc",
                              at = list(target_condition = c("CONTROL", 
                                                             "LOSS", 
                                                             "WARM")))

mod1b_simpslopes_bfi_me
```

##### Interaction

```{r}
targ_levels <-list(target_condition = c("CONTROL", "LOSS", "WARM"))

mod1b_simpslopes_bfi_int <- emtrends(model1b_bfi_randslopes, ~ target_condition*itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = c(targ_levels, threat_levels))

mod1b_simpslopes_bfi_int
```

#### Visualization

```{r}
mod1b_bfi_int <- effect("bfi_self_pmc:itt_comp_gmc:target_condition",
                         xlevels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07),
                                        target_condition = c("CONTROL",
                                                             "WARM",
                                                             "LOSS")),
                         mod = model1b_bfi_randslopes)

mod1b_bfi_int <- as.data.frame(mod1b_bfi_int)
mod1b_bfi_int$itt_comp_gmc <- as.factor(mod1b_bfi_int$itt_comp_gmc)
mod1b_bfi_int$target_condition <- as.factor(mod1b_bfi_int$target_condition)

threat_labels <- c("-1.07" = "Low target \n level threat",
                   "0" = "Average target \n level threat",
                   "1.07" = "High target \n level threat")

ggplot(mod1b_bfi_int, aes(bfi_self_pmc, fit, group = target_condition)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = target_condition)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  facet_wrap(~itt_comp_gmc,
             labeller = labeller(itt_comp_gmc = threat_labels)) +
  scale_linetype_manual("Target condition",
                        breaks = c("CONTROL", "WARM", "LOSS"), 
                       labels = c("Control",
                                  "Warm",
                                  "Loss"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(title = "Projection by target-level threat and target condition",
         subtitle = "Using the BFI",
       x = "BFI responses for self",
       y = "BFI responses for target")
```

## ELI

### MLM Results

### Random Slopes/No random Intercept

```{r}
model1b_eli_randslopes <- lmer(eli_targ_pmc ~ eli_self_pmc*itt_comp_gmc
                               *target_condition + 
                     (0 + eli_self_pmc | sub_id), 
                   data = mod_1_data_eli) # Model only works with the whole data-set (clean_data), not when filtered down to only include observations (thus none repeated) for this analysis with mod_1_data_bfi

tab_model(model1b_eli_randslopes,
          digits = 3)
```

Similiar to the BFI, but no interaction.

#### Simple Slopes

##### Target condition main effect

```{r}
mod1b_simpslopes_eli_me <- emtrends(model1b_eli_randslopes, ~ target_condition,
                              var ="eli_self_pmc",
                              at = list(target_condition = c("CONTROL", 
                                                             "LOSS", 
                                                             "WARM")))

mod1b_simpslopes_bfi_me
```

#### Visualization

```{r}
mod1b_eli <- effect("eli_self_pmc:target_condition",
                         xlevels = list(target_condition = c("CONTROL",
                                                             "WARM",
                                                             "LOSS")),
                         mod = model1b_eli_randslopes)

mod1b_eli <- as.data.frame(mod1b_eli)
mod1b_eli$target_condition <- as.factor(mod1b_eli$target_condition)

ggplot(mod1b_eli, aes(eli_self_pmc, fit, group = target_condition)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = target_condition)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  scale_linetype_manual("Target condition",
                        breaks = c("CONTROL", "WARM", "LOSS"), 
                       labels = c("Control",
                                  "Warm",
                                  "Loss"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(title = "Projection by target condition",
         subtitle = "Using the ELI; Accounting for threat composite",
       x = "ELI responses for self",
       y = "ELI responses for target")
```

# Model 2

# VIF?





