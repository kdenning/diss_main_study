---
title: "Supplemental Analyses"
output: 
    html_document:
      code_download: TRUE
      toc: TRUE
      toc_float:
        collapsed: FALSE
      toc_depth: 1
      code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r data prep, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
# Loading packages
library(psych)
library(effects)
library(magrittr) # part of the tidyverse but must be read in on its own
library(parameters)
library(dplyr)
library(tidyr)
library(rio)
library(ggplot2)
library(emmeans)
library(lavaan)
library(lme4)
library(sjPlot)

# Functions to clean document, get data from wide to long format
source("functions/Cleaning.R")

# Setting global chunk options
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

options(scipen = 999)

# Importing data
wide_data <- import("data/diss_main_combined_data_basic_clean.csv")

# Cleaning data using functions
long_data_bfi <- get_wrangled_bfi(wide_data)
long_data_eli <- get_wrangled_eli(wide_data)

clean_vars_bfi <- get_vars_cleaned(long_data_bfi)
clean_vars_eli <- get_vars_cleaned(long_data_eli)

clean_data_bfi <- remove_participants(clean_vars_bfi)
clean_data_eli <- remove_participants(clean_vars_eli)

clean_data_bfi %<>%    
  mutate(itt_comp = rowMeans(select(., c("realistic_q", "symbolic_q"))),
         itt_comp_gmc = itt_comp - mean(itt_comp, na.rm = TRUE))

clean_data_eli %<>%    
  mutate(itt_comp = rowMeans(select(., c("realistic_q", "symbolic_q"))),
         itt_comp_gmc = scale(itt_comp, center = T, scale = F))
```

# Intervention checks {.tabset .tabset-fade .tabset-pills}

## How much did they take Jen's perspective?

```{r}
pt_check_df <- clean_data_bfi %>% 
  select(sub_id, analog_condition, intervention_check1, intervention_check2, intervention_check3) %>% 
  unique() %>% 
  mutate(intervention_check1 = as.numeric(dplyr::recode(intervention_check1, #how much did you take Jen's perspective
                                             `Completely` = "4",
                                             `Moderately` = "3",
                                             `Slightly` = "2",
                                             `Not at all` = "1")), 
         intervention_check2 = as.numeric(dplyr::recode(intervention_check2, # How misunderstood is Jen
                                             `Always` = "4",
                                             `Slightly` = "3",
                                             `Rarely` = "2",
                                             `Not at all` = "1")))

pt_check_df %>% 
  group_by(analog_condition) %>% 
  mutate(mean = mean(intervention_check1),
         sd = sd(intervention_check1)) %>% 
  select(analog_condition, mean, sd) %>% 
  unique()
```

```{r}
int_check1_res <- aov(intervention_check1 ~ analog_condition, data = pt_check_df)
anova(int_check1_res)
```

How much they reported taking her perspective was not significantly different

## How misunderstood was Jen?

```{r}
pt_check_df %>% 
  group_by(analog_condition) %>% 
  mutate(mean = mean(intervention_check2),
         sd = sd(intervention_check2)) %>% 
  select(analog_condition, mean, sd) %>% 
  unique()
```

```{r}
int_check2_res <- aov(intervention_check2 ~ analog_condition, data = pt_check_df)
anova(int_check2_res)
```

How much they reported Jen was misunderstood was significantly different, with those in the analog condition saying she was more misunderstood. However, this did not have an effect on counter-projection.


# Checking mean/sd of bfi_self responses per item {.tabset .tabset-fade .tabset-pills}

```{r}
bfi_wide_self <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_self) %>% 
  unique() %>% 
  pivot_wider(names_from = bfi_number, values_from = bfi_self) %>% 
  select(sub_id, "1":"19") %>% 
  unique()

psych::describe(bfi_wide_self)
```

# Variance around threat composite by threat condition {.tabset .tabset-fade .tabset-pills}

```{r}
clean_data_bfi %>% 
  select(sub_id, itt_comp_gmc, target_condition) %>% 
  group_by(target_condition) %>% 
  mutate(mean = mean(itt_comp_gmc),
         sd = sd(itt_comp_gmc)) %>% 
  select(target_condition, mean, sd) %>% 
  unique()
```

## Control condition only

```{r}
filter_control <- clean_data_bfi %>% 
  filter(target_condition == "CONTROL")

hist(filter_control$itt_comp)
```

## Warm condition only

```{r}
filter_warm <- clean_data_bfi %>% 
  filter(target_condition == "WARM")

hist(filter_warm$itt_comp)
```

## Political loss condition only

```{r}
filter_loss <- clean_data_bfi %>% 
  filter(target_condition == "LOSS")

hist(filter_loss$itt_comp)
```

# Testing effect of centering

## Only composite

### erson mean centered

```{r}
data_bfi <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, itt_comp_gmc,
         target_condition, bfi_targ, bfi_self, bfi_stereo, bfi_stereo_pmc,
         bfi_targ_gmc, bfi_self_gmc, bfi_stereo_gmc) %>% 
  unique() %>% 
  na.omit() 

bfi_pmc1 <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc +
                     (bfi_self_pmc | sub_id), data = data_bfi)
summary(bfi_pmc1)
tab_model(bfi_pmc1)
```

### Grand mean centered

```{r}
bfi_gmc1 <- lmer(bfi_targ ~ bfi_self_gmc*itt_comp_gmc +
                     (bfi_self_gmc | sub_id), data = data_bfi)
summary(bfi_gmc1)
tab_model(bfi_gmc1)
```

# Mediation of target condition by target-level threat


```{r parallel processing version}
# Set-up for mediational model -------------------------------------------------
# Getting basic data cleaning data before for loops
data_4_med_bfi <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, itt_comp_gmc,
         target_condition) %>% 
  mutate(target_condition = forcats::fct_relevel(target_condition, c("CONTROL", "WARM", "LOSS"))) %>% 
  unique()
contrasts(data_4_med_bfi$target_condition)

my.helmert = matrix(c(2/3, -1/3, -1/3, 0, 1/2, -1/2), ncol = 2)
my.helmert

contrasts(data_4_med_bfi$target_condition) = my.helmert
df_ids <- data_4_med_bfi %>% 
    select(sub_id) %>% 
    unique()

df_items <- data_4_med_bfi %>% 
  group_by(sub_id)

# Empty df
   empty_df <- data.frame(matrix(vector(mode = 'numeric',length = 1), nrow = 1, ncol = 9))
  
# Renaming variables appropriately
  empty_df %<>%
    rename(a_cvl = X1,
         a_cvw =  X2,
         b = X3,
         c_cvl = X4,
         c_cvw = X5,
         c_prime_cvl = X6,
         c_prime_cvw = X7,
         total_cvl = X8,
         total_cvw = X9
         )

# Seeting up multiple cores
registerDoParallel(8)

# Set seed for multiple cores
registerDoRNG(1)

# Trials to be run
trials <- 10

# Looping with parallel processing with doParallel -----------------------------
## Keeping track of how long it takes
## 5 seconds versus 22 seconds per iteration without parallel processing
system.time({
med_df <- foreach(icount(trials)) %dopar% {
  # Getting samples ------------------------------------------------------------
  df_id_samp  <- df_ids %>% 
    slice_sample(n = 415)
  
  df_item_samp <- df_items %>% 
  sample_n(size = 19, replace = TRUE)
  
  df_samp <- left_join(df_id_samp, df_item_samp)
  
  df_lm <- df_samp %>% 
    select(sub_id, itt_comp_gmc, target_condition) %>% 
    unique()
  
  # Running model for non-mediated effect---------------------------------------
  targ_on_cp <- lmer(bfi_targ_pmc ~ bfi_self_pmc*target_condition +
                         (bfi_self_pmc | sub_id), 
                   data = df_samp)
  
  # Getting coefficients for direct effect of PT, non-mediated
  fixed_eff_targ_on_cp <- fixef(targ_on_cp) 
  c_cvw <- fixed_eff_targ_on_cp[5] # non mediated effect of target condition on projection
  c_cvl <- fixed_eff_targ_on_cp[6]
  
  # I did not use the ci's per model last time - to save on processing power, they are removed
  
  # Running model on indirect effect--------------------------------------------
  targ_on_threat <- lm(itt_comp_gmc ~ target_condition, data = df_lm)
  
  # Getting coefficient for indirect
  a_cvw <- targ_on_threat$coefficients[2] # effect of analog on threat; a
  a_cvl <- targ_on_threat$coefficients[3]
  
  # Running model on direct, mediated effect -----------------------------------
  threat_on_cp <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*target_condition +
                         (bfi_self_pmc | sub_id), 
                   data = df_samp)
  
  # getting fixed effects from lmer into subsettable format
  fixed_eff <- fixef(threat_on_cp) 
  b <- fixed_eff[6] # effect of threat on projection; b
  c_prime_cvw <- fixed_eff[7] # effect of pt on projection after accounting for threat; c'
  c_prime_cvl <- fixed_eff[8] 
  #did not use interaction last time, so not pulling it to save processing power

  
  # Putting coefficients into overall df----------------------------------------
  empty_df$a_cvl[1] <- round(a_cvl, digits = 3)
  empty_df$a_cvw[1] <- round(a_cvw, digits = 3)
  empty_df$b[1] <- round(b, digits = 3)
  empty_df$c_cvl[1] <- round(c_cvl, digits = 3)
  empty_df$c_cvw[1] <- round(c_cvw, digits = 3)
  empty_df$c_prime_cvl[1] <- round(c_prime_cvl, digits = 3)
  empty_df$c_prime_cvw[1] <- round(c_prime_cvw, digits = 3)
  empty_df$total_cvl[1] <- round(empty_df$a_cvl*empty_df$b+empty_df$c_prime_cvl, digits = 3)
  empty_df$total_cvw[1] <- round(empty_df$a_cvw*empty_df$b+empty_df$c_prime_cvw, digits = 3) 
  coeffs <- rbind(data.frame(), empty_df)
  
  }
})

med_results <- do.call(rbind.data.frame, med_df)

med_ave_estimates <- med_results %>% 
  # Analog was the reference condition, but I pre-registered that the control would be; multiped by "-1" to change direction for 
  # estimates affected by this error: a, c, and c_prime
  mutate(a = a*-1, 
         c = c*-1,
         c_prime = c_prime*-1,
         # indirect effect
         axb = (a*b)) %>% 
  mutate(a_mean = mean(a), # analog pt on threat
         b_mean = mean(b), # threat on counter-projection
         c_mean = mean(c), # analog pt on counter-projection
         cprime_mean = mean(c_prime),# analog pt on counter-projection including threat as covariate in model
         axb_mean = mean(axb),
         a_med = median(a),
         b_med = median(b),
         c_med = median(c),
         axb_med = median(axb),
         cprime_med = median(c_prime),
         a_cil = quantile(a, probs = .025),
         a_ciu = quantile(a, probs = .975),
         b_cil = quantile(b, probs = .025),
         b_ciu = quantile(b, probs = .975),
         c_cil = quantile(c, probs = .025),
         c_ciu = quantile(c, probs = .975),
         cprime_cil = quantile(c_prime, probs = .025),
         cprime_ciu = quantile(c_prime, probs = .975),
         axb_cil = quantile(axb, probs = .025),
         axb_ciu = quantile(axb, probs = .975)) %>% 
  select(a_mean, b_mean, c_mean, cprime_mean, 
         a_med, b_med, c_med, cprime_med,
         a_cil, a_ciu, b_cil, b_ciu, c_cil, c_ciu, cprime_cil, cprime_ciu, 
         axb_mean, axb_med, axb_cil, axb_ciu) %>% 
  unique() %>% 
  pivot_longer(a_mean:axb_ciu,
               names_sep = "_",
               names_to = c("Estimate", "statistic")) %>% 
  pivot_wider(names_from = statistic, values_from = value)

med_ave_estimates

# Exported data to save outside r environment
# med_results %>% 
#   mutate(model = 1:10000) %>% 
#   write.csv('bootstrap_mediation_output.csv', row.names = F)
```

https://quantpsy.org/pubs/hayes_preacher_2014.pdf

## Direct path c

```{r}
path_c2 <- lmer(bfi_targ_pmc ~ bfi_self_pmc*target_condition +
                     (bfi_self_pmc | sub_id), data = bfi_data)
summary(path_c2)
tab_model(path_c2)
```

### Simple Slopes

```{r}
targ_levels <-list(target_condition = c("CONTROL", "LOSS", "WARM"))
path_c2_effects <- emtrends(path_a2, ~ target_condition,
                              var ="bfi_self_pmc",
                              at = targ_levels)


path_a2_effects
test(path_c2_effects)
pairs(path_c2_effects)
```

### Visualization

```{r}
path_c2_data <- effect("bfi_self_pmc:target_condition",
                         xlevels = list(target_condition = c("CONTROL",
                                                             "WARM",
                                                             "LOSS")),
                         mod = path_c2)

path_c2_data <- as.data.frame(path_c2_data)
path_c2_data$target_condition <- as.factor(path_c2_data$target_condition)

path_c2_data %<>% 
  mutate(target_condition = forcats::fct_relevel(target_condition, c("CONTROL", "WARM", "LOSS")))

ggplot(path_c2_data, aes(bfi_self_pmc, fit, group = target_condition)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = TRUE,
                colour = "black", 
                aes(linetype = target_condition)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  scale_linetype_manual("Target Variable",
                        breaks = c("CONTROL", "WARM", "LOSS"), 
                       labels = c("Least threatening",
                                  "Medium threatening",
                                  "Most threatening"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(x = "BFI responses for self",
       y = "BFI responses for target")
```

### Assumptions

```{r}
# checking normality of conditional residuals
qqnorm(residuals(bfi_nostereo_targ), main="Q-Q plot for conditional residuals")

# checking the normality of the random effects (here random intercept):
qqnorm(ranef(bfi_nostereo_targ)$sub_id$bfi_self_pmc,
       main="Q-Q plot for the self random effect")

# Checking residuals for intercept
qqnorm(ranef(bfi_nostereo_targ)$sub_id$`(Intercept)`,
       main="Q-Q plot for the random intercept")

plot_model(bfi_nostereo_targ, type='diag')
```

# Exploring different personality traits and counter-projection

## Extraversion

```{r extra data}
# Getting data for extraversion model
extra_mod_data <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, bfi_stereo_pmc, itt_comp_gmc) %>% 
  filter(bfi_number == 1 | bfi_number == 6 | bfi_number == 11) %>% 
  unique() %>% 
  na.omit()

extra_mod_nostereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc +
                     (bfi_self_pmc | sub_id), data = extra_mod_data) # singular with correlation betwwen intercept and random slope equal to 0 and random slope very close to o
summary(extra_mod_nostereo)
tab_model(extra_mod_nostereo)
```


### Simple slopes

```{r}
threat_levels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07))
extra_ss <- emtrends(extra_mod_nostereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

extra_ss 
test(extra_ss)
pairs(extra_ss)
```

Normal pattern: Counter-projection with those who perceive high threat, positive projection with those who perceive low threat, neither at average threat; however, model was singular due to perfect correlation between random intercept and slope of self ratings, likely due to so few items being nested within each person

### With stereotyping

```{r}
extra_mod_stereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*bfi_stereo_pmc +
                     (bfi_self_pmc | sub_id), data = extra_mod_data) # no longer singular, but cannot have stereo be random because there are not enough observations for that many random effects
summary(extra_mod_stereo)
tab_model(extra_mod_stereo)
```

#### Simple slopes

```{r}
extra_ss_stereo <- emtrends(extra_mod_stereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

extra_ss_stereo 
```

No longer counter-projection, now both average and high are neither projecting nor counter-projecting while low are projecting

## Agreeableness

```{r agreeable data}
# Getting data for extraversion model
agree_mod_data <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, bfi_stereo_pmc, itt_comp_gmc) %>% 
  filter(bfi_number == 2 | bfi_number == 7 | bfi_number == 12) %>% 
  unique() %>% 
  na.omit()

agree_mod_nostereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc +
                     (bfi_self_pmc | sub_id), data = agree_mod_data)
summary(agree_mod_nostereo)
tab_model(agree_mod_nostereo)
```

Not singular but no interaction of threat and self

### Simple slopes

```{r}
agree_ss <- emtrends(agree_mod_nostereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

agree_ss 
test(agree_ss)
pairs(agree_ss)
```

People positively project on all agreeable traits.

### With stereotyping

```{r}
agree_mod_stereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*bfi_stereo_pmc +
                     (bfi_self_pmc | sub_id), data = agree_mod_data) # no longer singular, but cannot have stereo be random because there are not enough observations for that many random effects
tab_model(agree_mod_stereo)
```


#### Simple slopes

```{r}
agree_ss_stereo <- emtrends(agree_mod_stereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

agree_ss_stereo
```

No change

## Conscientiousness

```{r agreeable data}
# Getting data for extraversion model
conscientious_mod_data <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, bfi_stereo_pmc, itt_comp_gmc) %>% 
  filter(bfi_number == 3 | bfi_number == 8 | bfi_number == 13) %>% 
  unique() %>% 
  na.omit()

conscientious_mod_nostereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc +
                     (bfi_self_pmc | sub_id), data = conscientious_mod_data)
summary(conscientious_mod_nostereo)
tab_model(conscientious_mod_nostereo)
```

### Simple slopes

```{r}
conscientious_ss <- emtrends(conscientious_mod_nostereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

conscientious_ss
test(conscientious_ss)
pairs(conscientious_ss)
```

Normal pattern: People counter-projected when high threat, projected at low threat, neither at average threat

### With stereotyping

```{r}
conscientious_mod_stereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*bfi_stereo_pmc +
                     (bfi_self_pmc | sub_id), data = conscientious_mod_data) # no longer singular, but cannot have stereo be random because there are not enough observations for that many random effects
tab_model(conscientious_mod_stereo)
```

Significant interaction goes away...

#### Simple slopes

```{r}
conscientious_ss_stereo <- emtrends(conscientious_mod_stereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

conscientious_ss_stereo
```

No projection or counter-projection regardless of threat level

## Negative emotionality

```{r agreeable data}
# Getting data for extraversion model
negemo_mod_data <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, bfi_stereo_pmc, itt_comp_gmc) %>% 
  filter(bfi_number == 4 | bfi_number == 9 | bfi_number == 14) %>% 
  unique() %>% 
  na.omit()

negemo_mod_nostereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc +
                     (bfi_self_pmc | sub_id), data = negemo_mod_data)
summary(negemo_mod_nostereo)
tab_model(negemo_mod_nostereo)
```

## Simple slopes

```{r}
negemo_ss <- emtrends(negemo_mod_nostereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

negemo_ss
test(negemo_ss)
pairs(negemo_ss)
```

Same pattern: High threat counter-projects, low threat projects, average threat does neither

### With stereotyping

```{r}
negemo_mod_stereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*bfi_stereo_pmc +
                     (bfi_self_pmc | sub_id), data = negemo_mod_data) 
tab_model(negemo_mod_stereo)
```

#### Simple slopes

```{r}
negemo_ss_stereo <- emtrends(negemo_mod_stereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

negemo_ss_stereo
```

Positive projection with low perceivers and average perceivers, while high are doing neither

## Open-mindedness

```{r open minded data}
# Getting data for extraversion model
open_mod_data <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, bfi_stereo_pmc, itt_comp_gmc) %>% 
  filter(bfi_number == 5 | bfi_number == 10 | bfi_number == 15) %>% 
  unique() %>% 
  na.omit()

open_mod_nostereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc +
                     (bfi_self_pmc | sub_id), data = open_mod_data)
summary(open_mod_nostereo)
tab_model(open_mod_nostereo)
```

## Simple slopes

```{r}
open_ss <- emtrends(open_mod_nostereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

open_ss
test(negemo_ss)
pairs(negemo_ss)
```

Slightly different: No counter-projection - both high and average neither counter-project or project, while low perceivers project

### With stereotyping

```{r}
open_mod_stereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*bfi_stereo_pmc +
                     (bfi_self_pmc | sub_id), data = open_mod_data) 
tab_model(negemo_mod_stereo)
```

#### Simple slopes

```{r}
open_ss_stereo <- emtrends(open_mod_stereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

open_ss_stereo
```

Both high and average are not projecting nor counter-projection, while low perceivers are positively projecting


## Honesty

```{r honesty data}
# Getting data for extraversion model
honesty_mod_data <- clean_data_bfi %>% 
  select(sub_id, bfi_number, bfi_targ_pmc, bfi_self_pmc, bfi_stereo_pmc, itt_comp_gmc) %>% 
  filter(bfi_number == 16 | bfi_number == 17 | bfi_number == 18 | bfi_number == 19) %>% 
  unique() %>% 
  na.omit()

honesty_mod_nostereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc +
                     (bfi_self_pmc | sub_id), data = honesty_mod_data)
summary(honesty_mod_nostereo)
tab_model(honesty_mod_nostereo)
```

## Simple slopes

```{r}
honesty_ss <- emtrends(honesty_mod_nostereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

honesty_ss
test(honesty_ss)
pairs(honesty_ss)
```

People are neither projecting nor counter-projecting in high threat and project in the rest

### With stereotyping

```{r}
honesty_mod_stereo <- lmer(bfi_targ_pmc ~ bfi_self_pmc*itt_comp_gmc*bfi_stereo_pmc +
                     (bfi_self_pmc | sub_id), data = honesty_mod_data) 
tab_model(honesty_mod_stereo)
```

#### Simple slopes

```{r}
honesty_ss_stereo <- emtrends(honesty_mod_stereo, ~ itt_comp_gmc,
                              var ="bfi_self_pmc",
                              at = threat_levels)

honesty_ss_stereo
```

The pattern did not change after stereotyping was accounted for

# Checking if difference between average and idiographic stereotypes explain counter-projection

## ELI

```{r}
# Grouped by threat condition bc stereotype likely varies by condition; grouped by item bc stereotype may vary by item
eli_stereo_exp_data <- clean_data_eli %>% 
  group_by(eli_number, target_condition) %>% 
  mutate(eli_stereo_ave = mean(eli_stereo)) %>% 
  ungroup() %>% 
  mutate(eli_diff = abs(eli_stereo - eli_stereo_ave))

eli_diff_mod <- lmer(eli_targ_pmc ~ eli_self_pmc*eli_diff*itt_comp_gmc +
       (0 + eli_self_pmc | sub_id), data = eli_stereo_exp_data)

tab_model(eli_diff_mod)
summary(eli_diff_mod)
```

### Simple slopes

#### Main effect diff

```{r}
psych::describe(eli_stereo_exp_data$eli_diff)

diff_levels = list(eli_diff = c(0.0, 0.6, 1.2)) # since this is a difference score with 0 difference being the bottom of the range; the sds only go up
diff_eli_ss_me <- emtrends(eli_diff_mod, ~ eli_diff,
                              var ="eli_self_pmc",
                              at = c(diff_levels))
diff_eli_ss_me
```

#### Interaction

```{r}

diff_eli_ss <- emtrends(eli_diff_mod, ~ itt_comp_gmc*eli_diff,
                              var ="eli_self_pmc",
                              at = c(threat_levels, diff_levels))
diff_eli_ss
```

### Visualizations

#### Main effect

```{r}
effects_diff_df_me <- effect("eli_self_pmc:eli_diff",
                         xlevels = list(eli_diff = c(0.0, 0.6, 1.2)),  # since this is a difference score with 0 difference being the bottom of the range; the sds only go up
                         mod = eli_diff_mod)

effects_diff_df_me <- as.data.frame(effects_diff_df_me)
effects_diff_df_me$eli_diff <- as.factor(effects_diff_df_me$eli_diff)
  
ggplot(effects_diff_df_int, aes(eli_self_pmc, fit, group = eli_diff)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = eli_diff)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  scale_linetype_manual("Difference from \ngroup stereotype",
                        breaks = c("0", "0.6", "1.2"), 
                       labels = c("None",
                                  "1 SD",
                                  "2 SD"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(x = "ELI responses for self",
       y = "ELI responses for target")
```

#### Interaction

```{r}
effects_diff_df_int <- effect("eli_self_pmc:eli_diff:itt_comp_gmc",
                         xlevels = list(itt_comp_gmc = c(-1.07, 0.0, 1.07),
                                        eli_diff = c(0.0, 0.6, 1.2)),  # since this is a difference score with 0 difference being the bottom of the range; the sds only go up
                         mod = eli_diff_mod)

effects_diff_df_int <- as.data.frame(effects_diff_df_int)
effects_diff_df_int$itt_comp_gmc <- as.factor(effects_diff_df_int$itt_comp_gmc)
effects_diff_df_int$eli_diff <- as.factor(effects_diff_df_int$eli_diff)
  
threat_labels <- c("-1.07" = "Low target \n level threat",
                   "0" = "Average target \n level threat",
                   "1.07" = "High target \n level threat")

ggplot(effects_diff_df_int, aes(eli_self_pmc, fit, group = eli_diff)) +
  geom_smooth(method = "lm", 
                size = .7, 
                se = FALSE,
                colour = "black", 
                aes(linetype = eli_diff)) +
    theme_minimal(base_size = 13) +
    theme(legend.key.size = unit(1, "cm")) +
  facet_wrap(~itt_comp_gmc,
             labeller = labeller(itt_comp_gmc = threat_labels)) +
  scale_linetype_manual("Difference from \ngroup stereotype",
                        breaks = c("0", "0.6", "1.2"), 
                       labels = c("None",
                                  "1 SD",
                                  "2 SD"),
                       values = c("solid",
                                  "dashed",
                                  "dotted")) +
    labs(x = "ELI responses for self",
       y = "ELI responses for target")
```


In the high threat condition, there is more variation from the stereotype, with people 


## BFI

```{r}
# Grouped by threat condition bc stereotype likely varies by condition; grouped by item bc stereotype may vary by item
bfi_stereo_exp_data <- clean_data_bfi %>% 
  group_by(bfi_number, target_condition) %>% 
  mutate(bfi_stereo_ave = mean(bfi_stereo)) %>% 
  ungroup() %>% 
  mutate(bfi_diff = abs(bfi_stereo - bfi_stereo_ave))

bfi_diff_mod <- lmer(bfi_targ_pmc ~ bfi_self_pmc*bfi_diff*itt_comp_gmc +
       (bfi_self_pmc | sub_id), data = bfi_stereo_exp_data)

tab_model(bfi_diff_mod)
summary(bfi_diff_mod)
```

No interactions of projection with bfi_diff